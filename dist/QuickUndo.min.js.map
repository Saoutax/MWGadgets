{"version":3,"file":"QuickUndo.min.js","mappings":"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","sources":["webpack://mwgadgets/./src/QuickUndo/index.js"],"sourcesContent":["$(function () {\r\n    function undo(pageid, undoid, undoafter, ignoreabusefilter = true) {\r\n        new mw.Api().getToken('csrf').then(function(token) {\r\n            ajaxdata = {\r\n                \"action\": \"edit\",\r\n                \"format\": \"json\",\r\n                \"pageid\": pageid,\r\n                \"summary\": '// QuickUndo',\r\n                \"undo\": undoid,\r\n                \"token\": token,\r\n            };\r\n            if (undoafter) ajaxdata.undoafter = undoafter;\r\n            mw.notify('正在操作');\r\n            $.ajax({\r\n                type: \"POST\",\r\n                url: '/api.php',\r\n                data: ajaxdata,\r\n                success: function (data) {\r\n                    if (data.edit && data.edit.result == 'Success') {\r\n                        if (data.edit.nochange != undefined) {\r\n                            mw.notify('这次编辑似乎已被撤销。');\r\n                        } else {\r\n                            mw.notify('完成');\r\n                            setTimeout(function () { window.open('/Special:Diff/' + data.edit.newrevid); }, 0);\r\n                        }\r\n                    } else if (data.edit && data.edit.result == 'Failure' && data.edit.abusefilter && data.edit.abusefilter.actions.indexOf('warn') != -1 && ignoreabusefilter) {\r\n                        mw.notify('遇到过滤器' + data.edit.abusefilter.id + '（' + data.edit.abusefilter.description + '），忽略警告');\r\n                        setTimeout(function () { undo(pageid, undoid, undoafter, false) }, 0);\r\n                    } else if (data.error && data.error.info == 'The edit could not be undone due to conflicting intermediate edits.') {\r\n                        mw.notify('因存在冲突的中间编辑，本编辑不能撤销。');\r\n                    } else {\r\n                        mw.notify('出现未知错误，以下是错误信息:'\r\n                            + JSON.stringify(data));\r\n                        console.log(JSON.stringify(data))\r\n                    }\r\n                },\r\n                error: function () {\r\n                    mw.notify('网络连接出错');\r\n                }\r\n            });\r\n        }).catch(function() {\r\n            mw.notify('获取编辑令牌失败');\r\n        });\r\n    }\r\n    if (mw.config.values.wgDiffNewId || mw.config.values.wgDiffOldId) {\r\n        $('.mw-diff-undo').each(function () {\r\n            this.innerHTML = this.innerHTML.replace(/）$/, '/<a href=\"#.\" title = \"无需确定并忽略过滤器警告\" class=\"quickundo_diff\">快速撤销</a >）')\r\n        });\r\n        $('a.quickundo_diff').each(function () {\r\n            this.onclick = function () {\r\n                undo(mw.config.values.wgArticleId, mw.config.values.wgDiffNewId, mw.config.values.wgDiffOldId);\r\n            }\r\n        });\r\n    }\r\n    if (mw.config.values.wgAction == 'history') {\r\n        $('.mw-history-undo').append('/<a href=\"#.\" title = \"无需确定并忽略过滤器警告\" class=\"quickundo_history\">快速撤销</a >');\r\n        $('a.quickundo_history').each(function () {\r\n            this.onclick = function () {\r\n                var href = $(this).parents('span.mw-history-undo').children('a:not(.quickundo_history)')[0].href;\r\n                var undoid = href.match(/undo=(\\d+)/)[1];\r\n                var undoafter = href.match(/undoafter=(\\d+)/)[1];\r\n                undo(mw.config.values.wgArticleId, undoid, undoafter);\r\n            }\r\n        });\r\n\r\n        var last_user = $('.history-user:first .mw-userlink:first')[0].href;\r\n        var undoafter = -1;\r\n        var times = 0;\r\n        $.each($('.history-user .mw-userlink'), function () {\r\n            if (this.href != last_user) {\r\n                undoafter = $(this).parents('li')[0].dataset.mwRevid;\r\n                return false;\r\n            } else {\r\n                times++;\r\n            }\r\n        });\r\n        var rollback = document.createElement('a');\r\n        rollback.innerText = '回退' + times + '次的编辑';\r\n        rollback.href = '#.';\r\n        rollback.onclick = function () {\r\n            undo(mw.config.values.wgArticleId, mw.config.values.wgCurRevisionId, undoafter);\r\n        }\r\n        $('#pagehistory li:first').append('[').append(rollback).append(']')\r\n    }\r\n    window.QuickDiffExtension = window.QuickDiffExtension || [];\r\n    window.QuickDiffExtension.push(function (that, data) {\r\n        $(that).find('#quick-diff-content').prepend('<input class=\"quick-undo-quick-diff\" title=\"无需确定并忽略过滤器警告\" type=\"submit\" value=\"快速撤销此编辑\">');\r\n        $(that).find('input.quick-undo-quick-diff').each(function () {\r\n            this.onclick = function () {\r\n                undo(data.compare.fromid, data.compare.fromrevid, data.compare.torevid);\r\n            }\r\n        });\r\n    });\r\n});"],"names":["$","undo","pageid","undoid","undoafter","ignoreabusefilter","arguments","length","undefined","mw","Api","getToken","then","token","ajaxdata","notify","ajax","type","url","data","success","edit","result","nochange","setTimeout","window","open","newrevid","abusefilter","actions","indexOf","id","description","error","info","JSON","stringify","console","log","config","values","wgDiffNewId","wgDiffOldId","each","this","innerHTML","replace","onclick","wgArticleId","wgAction","append","href","parents","children","match","last_user","times","dataset","mwRevid","rollback","document","createElement","innerText","wgCurRevisionId","QuickDiffExtension","push","that","find","prepend","compare","fromid","fromrevid","torevid"],"sourceRoot":""}